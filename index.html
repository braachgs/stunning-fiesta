<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CARVE-Markov Risk Valuation Engine</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f7fafc; }
        .card { background-color: white; border-radius: 0.75rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        input[type="text"], input[type="number"], textarea, select { border: 1px solid #d1d5db; border-radius: 0.375rem; padding: 0.75rem; transition: border-color 0.15s ease-in-out; }
        input[type="text"]:focus, input[type="number"]:focus, textarea:focus, select:focus { border-color: #4f46e5; outline: 0; box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.25); }
        .btn-primary { background-color: #4f46e5; color: white; padding: 0.75rem 1.5rem; border-radius: 0.5rem; transition: background-color 0.2s; font-weight: 600; cursor: pointer; }
        .btn-primary:hover { background-color: #4338ca; }
        .btn-secondary { background-color: #e5e7eb; color: #1f2937; padding: 0.75rem 1.5rem; border-radius: 0.5rem; transition: background-color 0.2s; font-weight: 600; cursor: pointer; }
        .btn-secondary:hover { background-color: #d1d5db; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #4f46e5; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; margin-right: 0.5rem; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <header class="mb-8">
            <h1 class="text-4xl font-bold text-gray-900">CARVE-Markov Risk Valuation Engine</h1>
            <p class="text-lg text-gray-600">Quantifiable Financial Risk Modeling for Voluntary Carbon Offtake Agreements.</p>
        </header>

        <div id="error-message" class="hidden p-4 mb-6 text-sm text-red-800 bg-red-100 rounded-lg" role="alert"></div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- Input Form Column -->
            <div class="lg:col-span-1 card p-6 h-fit sticky top-4">
                <h2 class="text-2xl font-semibold mb-4 text-indigo-700">Project Input</h2>
                <form id="carve-form">
                    <div class="space-y-4">
                        <label class="block">
                            <span class="text-gray-700 font-medium">Project Name & Registry ID (e.g., VCS1477)</span>
                            <input type="text" id="projectName" class="mt-1 block w-full" placeholder="Indian Biochar Project">
                        </label>
                        <label class="block">
                            <span class="text-gray-700 font-medium">Offtake Term (Years)</span>
                            <input type="number" id="offtakeTerm" class="mt-1 block w-full" value="5" min="1" max="15">
                        </label>
                        <label class="block">
                            <span class="text-gray-700 font-medium">Total Contract Value (USD)</span>
                            <input type="number" id="contractValue" class="mt-1 block w-full" value="2000000" min="1000">
                        </label>
                        <label class="block">
                            <span class="text-gray-700 font-medium">Host Country of Implementation</span>
                            <input type="text" id="hostCountry" class="mt-1 block w-full" placeholder="India">
                        </label>
                        <label class="block">
                            <span class="text-gray-700 font-medium">Registry Quality Score (1-100) - Puro=90, Verra=80, ACR=75, GoldStandard=85</span>
                            <input type="number" id="registryScore" class="mt-1 block w-full" value="90" min="1" max="100">
                        </label>
                        <label class="block">
                            <span class="text-gray-700 font-medium">Country INFORM Risk Score (0-10)</span>
                            <input type="number" id="informRisk" class="mt-1 block w-full" value="5.6" min="0" max="10" step="0.1">
                        </label>
                        
                        <div class="bg-indigo-50 p-4 rounded-lg">
                            <h3 class="font-semibold text-indigo-800 mb-2">Manual CARVE Execution Scores (1-100)</h3>
                            <p class="text-sm text-indigo-700 mb-2">Enter 7 scores, separated by commas, in this order:</p>
                            <code class="block text-xs p-2 bg-indigo-100 rounded mb-2 font-mono">1. Financial Viability, 2. Developer Experience (Methodology), 3. Developer Experience (Country), 4. Methodology Robustness, 5. On-Time Issuance History, 6. Community/Land Tenure Risk, 7. Pre-Payment Status</code>
                            <textarea id="manualScores" class="mt-1 block w-full h-24 font-mono text-sm" placeholder="65, 80, 75, 95, 40, 70, 90"></textarea>
                        </div>
                    </div>
                </form>

                <div class="flex flex-col space-y-3 mt-6">
                    <button onclick="runAnalysis()" class="btn-primary flex items-center justify-center" id="runAnalysisBtn">
                        <span id="analysisBtnText">Run Single CARVE-Markov Analysis</span>
                    </button>
                    <button onclick="loadSampleData()" class="btn-secondary" id="loadSampleBtn">
                        Load Single Sample Project
                    </button>
                </div>
            </div>

            <!-- Results Column -->
            <div class="lg:col-span-2 space-y-8">
                
                <!-- Summary and Bulk Actions -->
                <div class="card p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-semibold text-gray-900">CARVE Analysis Summary</h2>
                        <button onclick="runBulkAnalysis()" class="btn-secondary whitespace-nowrap" id="runBulkBtn">
                            Run Bulk Analysis (10 Test Projects)
                        </button>
                    </div>

                    <!-- Individual Project Results -->
                    <div id="results-summary" class="hidden bg-yellow-50 p-4 rounded-lg border-l-4 border-yellow-500">
                        <h3 class="text-xl font-bold text-gray-800 mb-3" id="resultProjectName"></h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                            <div>
                                <p class="text-xs font-medium text-gray-500 uppercase">CARVE Score</p>
                                <p class="text-2xl font-extrabold text-indigo-600" id="resultScore"></p>
                            </div>
                            <div>
                                <p class="text-xs font-medium text-gray-500 uppercase">P(Collapse)</p>
                                <p class="text-2xl font-extrabold text-red-600" id="resultPCollapse"></p>
                            </div>
                            <div>
                                <p class="text-xs font-medium text-gray-500 uppercase">VaR (USD)</p>
                                <p class="text-2xl font-extrabold text-red-600" id="resultVaR"></p>
                            </div>
                            <div>
                                <p class="text-xs font-medium text-gray-500 uppercase">P(Underperformance/Default)</p>
                                <p class="text-2xl font-extrabold text-yellow-600" id="resultPUnderperf"></p>
                            </div>
                        </div>
                        <button onclick="generateFullReport()" class="btn-primary w-full mt-4 flex items-center justify-center" id="generateReportBtn">
                            <span id="reportBtnText">Generate Full Report (Powered by Gemini)</span>
                        </button>
                    </div>
                    
                    <!-- Bulk Results Table -->
                    <div id="bulk-results-container" class="hidden mt-4">
                        <h3 class="text-xl font-bold text-gray-800 mb-3">Bulk Analysis Results (10 Projects)</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Project ID</th>
                                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">CARVE Score</th>
                                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">P(Collapse)</th>
                                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">VaR (USD)</th>
                                    </tr>
                                </thead>
                                <tbody id="bulk-results-table" class="bg-white divide-y divide-gray-200">
                                    <!-- Results dynamically inserted here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Final Report Display -->
                <div id="report-output-container" class="card p-6 hidden">
                    <h2 class="text-2xl font-semibold text-gray-900 mb-4">Generated Risk Report</h2>
                    <div id="report-output" class="prose max-w-none p-4 border rounded-lg bg-white overflow-y-auto h-[700px]">
                        <!-- Report content will be inserted here -->
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script type="module">
        // Global variables for Firebase access (required by the platform, but not used in this local script)
        const __app_id = 'default-carve-app';
        const __firebase_config = '{}'; 
        const __initial_auth_token = 'none';

        // --- CORE CARVE-MARKOV ENGINE LOGIC & DATA ---

        // Test Project Data (10 Projects for Bulk Analysis)
        const TEST_PROJECTS = [
            // Format: [Project Name, Term (Y), Value (USD), Country, Registry Score, INFORM Risk, [Manual Scores...]]
            ["Indian Biochar Project", 5, 2000000, "India", 90, 5.6, [65, 80, 75, 95, 40, 70, 90]],
            ["BECCS (VCS5212)", 5, 17920128, "Denmark", 80, 2.1, [85, 90, 95, 85, 90, 85, 80]],
            ["Biochar (GS12234)", 5, 14850058, "Colombia", 85, 4.3, [70, 75, 65, 90, 50, 60, 85]],
            ["Biochar (VCS4001)", 10, 17092405, "Switzerland", 80, 1.4, [80, 85, 80, 90, 70, 75, 95]],
            ["A/R (VCS1378)", 10, 15181287, "Colombia", 80, 4.3, [50, 60, 50, 70, 30, 40, 70]],
            ["A/R (VCS4255)", 7, 17809379, "Sierra Leone", 80, 6.7, [45, 55, 40, 65, 20, 35, 60]],
            ["DAC (VCS5525)", 7, 7927812, "United States", 80, 3.2, [90, 95, 90, 95, 80, 85, 100]],
            ["Manure Methane (CAR1009)", 3, 11653805, "United States", 75, 3.2, [95, 90, 90, 90, 95, 85, 100]],
            ["HFC Refrigerant (ACR945)", 3, 15840638, "United States", 75, 3.2, [95, 95, 95, 90, 98, 90, 100]],
            ["Concrete (GS11627)", 5, 18061972, "Switzerland", 85, 1.4, [90, 90, 85, 95, 85, 80, 95]]
        ];

        // Weights for the CARVE Score (sum to 1.0)
        const WEIGHTS = {
            registry: 0.05, // Registry (dampened to 5%)
            informRisk: 0.15, // External (INFORM)
            // Execution/Methodology (80% combined)
            financialViability: 0.15,
            devExperienceMethodology: 0.10,
            devExperienceCountry: 0.05,
            methodologyRobustness: 0.15,
            onTimeIssuance: 0.15,
            communityLandTenure: 0.10,
            prePayment: 0.05,
        };

        // Base Markov Chain Transition Matrix (P: Performing, U: Under-delivering, D: Default)
        // Values are adjusted based on the calculated CARVE Score.
        const BASE_MATRIX = {
            'P': { 'P': 0.90, 'U': 0.08, 'D': 0.02 },
            'U': { 'P': 0.05, 'U': 0.85, 'D': 0.10 },
            'D': { 'P': 0.00, 'U': 0.00, 'D': 1.00 }
        };

        // Global storage for the last analysis data and results
        window.lastAnalysisData = null;
        window.lastAnalysisResults = null;

        /**
         * Validates and retrieves all data from the form.
         * @returns {Object|null} The parsed data object or null if validation fails.
         */
        function getFormData() {
            const data = {
                projectName: document.getElementById('projectName').value.trim(),
                offtakeTerm: parseInt(document.getElementById('offtakeTerm').value),
                contractValue: parseFloat(document.getElementById('contractValue').value),
                hostCountry: document.getElementById('hostCountry').value.trim(),
                registryScore: parseFloat(document.getElementById('registryScore').value),
                informRisk: parseFloat(document.getElementById('informRisk').value),
                manualScoresInput: document.getElementById('manualScores').value.trim(),
            };
            
            const manualScores = data.manualScoresInput.split(',').map(s => parseFloat(s.trim())).filter(n => !isNaN(n));
            const errorDiv = document.getElementById('error-message');
            errorDiv.classList.add('hidden');
            errorDiv.innerHTML = '';

            const errors = [];

            if (!data.projectName || !data.hostCountry) { errors.push("Project Name and Host Country are required."); }
            if (isNaN(data.offtakeTerm) || data.offtakeTerm < 1) { errors.push("Offtake Term must be a positive number."); }
            if (isNaN(data.contractValue) || data.contractValue < 1000) { errors.push("Total Contract Value must be a positive number."); }
            if (isNaN(data.registryScore) || data.registryScore < 1 || data.registryScore > 100) { errors.push("Registry Score must be between 1 and 100."); }
            if (isNaN(data.informRisk) || data.informRisk < 0 || data.informRisk > 10) { errors.push("INFORM Risk Score must be between 0 and 10."); }
            
            if (manualScores.length !== 7) { errors.push(`Manual Scores require exactly 7 comma-separated values. ${manualScores.length} found.`); }
            else if (manualScores.some(s => s < 1 || s > 100)) { errors.push("All 7 manual scores must be between 1 and 100."); }

            if (errors.length > 0) {
                errorDiv.innerHTML = `<strong>Input Error:</strong><ul>${errors.map(e => `<li>- ${e}</li>`).join('')}</ul>`;
                errorDiv.classList.remove('hidden');
                return null;
            }

            // Map manual scores to weighted factors
            const [
                financialViability,
                devExperienceMethodology,
                devExperienceCountry,
                methodologyRobustness,
                onTimeIssuance,
                communityLandTenure,
                prePayment
            ] = manualScores;

            return {
                ...data,
                scores: {
                    financialViability,
                    devExperienceMethodology,
                    devExperienceCountry,
                    methodologyRobustness,
                    onTimeIssuance,
                    communityLandTenure,
                    prePayment,
                    // Calculated scores based on inputs
                    registry: data.registryScore,
                    informRisk: 100 - (data.informRisk * 10), // Convert 0-10 INFORM to 0-100 risk score
                }
            };
        }

        /**
         * Calculates the weighted CARVE Score.
         * @param {Object} scores - The individual risk scores (0-100).
         * @returns {number} The final CARVE Score (0-100, where 100 is best).
         */
        function calculateCarveScore(scores) {
            let totalWeightedScore = 0;

            // Execution/Methodology Scores (Higher is better, 100=no risk)
            totalWeightedScore += scores.financialViability * WEIGHTS.financialViability;
            totalWeightedScore += scores.devExperienceMethodology * WEIGHTS.devExperienceMethodology;
            totalWeightedScore += scores.devExperienceCountry * WEIGHTS.devExperienceCountry;
            totalWeightedScore += scores.methodologyRobustness * WEIGHTS.methodologyRobustness;
            totalWeightedScore += scores.onTimeIssuance * WEIGHTS.onTimeIssuance;
            totalWeightedScore += scores.communityLandTenure * WEIGHTS.communityLandTenure;
            totalWeightedScore += scores.prePayment * WEIGHTS.prePayment;
            
            // Systemic Scores (Higher is better)
            totalWeightedScore += scores.registry * WEIGHTS.registry;

            // External Risk (Higher is better)
            totalWeightedScore += scores.informRisk * WEIGHTS.informRisk;
            
            return Math.min(100, Math.max(0, totalWeightedScore));
        }

        /**
         * Calculates the Markov Chain transition matrix based on the CARVE Score.
         * @param {number} carveScore - The calculated CARVE Score (0-100).
         * @returns {Object} The adjusted transition matrix.
         */
        function calculateTransitionMatrix(carveScore) {
            // Factor is based on the deviation from a neutral score (e.g., 70)
            const neutralScore = 70;
            const adjustmentFactor = (carveScore - neutralScore) / 100;

            // Base transition matrix for a neutral score (CARVE Score = 70)
            const matrix = JSON.parse(JSON.stringify(BASE_MATRIX));
            
            // Adjustments: A higher CARVE Score should INCREASE P->P and DECREASE P->U/D and U->D.
            const P_P_ADJ = adjustmentFactor * 0.15; // Max 15% swing on P->P
            const P_U_ADJ = -adjustmentFactor * 0.08; // Max 8% swing on P->U
            const P_D_ADJ = -adjustmentFactor * 0.07; // Max 7% swing on P->D
            const U_D_ADJ = -adjustmentFactor * 0.05; // Max 5% swing on U->D

            // Apply adjustments to P row
            matrix.P.P = Math.min(1.0, Math.max(0.70, matrix.P.P + P_P_ADJ));
            matrix.P.U = Math.min(0.30, Math.max(0, matrix.P.U + P_U_ADJ));
            matrix.P.D = Math.min(0.30, Math.max(0, matrix.P.D + P_D_ADJ));
            
            // Re-normalize P row to ensure P+U+D = 1
            const pSum = matrix.P.P + matrix.P.U + matrix.P.D;
            if (pSum !== 1.0) {
                const diff = 1.0 - pSum;
                matrix.P.P += diff * 0.5;
                matrix.P.U += diff * 0.3;
                matrix.P.D += diff * 0.2;
            }
            
            // Apply adjustments to U row
            matrix.U.D = Math.min(1.0, Math.max(0, matrix.U.D + U_D_ADJ));
            matrix.U.P = matrix.U.P - U_D_ADJ * 0.5; // Re-allocate from D to P for better projects
            matrix.U.U = 1.0 - matrix.U.P - matrix.U.D; // Ensure U+P+D = 1
            matrix.U.U = Math.max(0, matrix.U.U);
            
            // Ensure D row remains stable (absorbing state)
            matrix.D = { 'P': 0.00, 'U': 0.00, 'D': 1.00 };

            return matrix;
        }

        /**
         * Executes the Markov Chain simulation over the given term.
         * @param {Object} matrix - The transition matrix.
         * @param {number} term - The number of years.
         * @returns {Object} The final state probabilities (P, U, D).
         */
        function runMarkovChain(matrix, term) {
            let state = { P: 1.0, U: 0.0, D: 0.0 }; // Start 100% in Performing
            
            for (let year = 1; year <= term; year++) {
                const nextState = { P: 0, U: 0, D: 0 };
                
                // P -> P, U, D
                nextState.P += state.P * matrix.P.P;
                nextState.U += state.P * matrix.P.U;
                nextState.D += state.P * matrix.P.D;

                // U -> P, U, D
                nextState.P += state.U * matrix.U.P;
                nextState.U += state.U * matrix.U.U;
                nextState.D += state.U * matrix.U.D;

                // D -> P, U, D (D is absorbing, so D->D is 1.0)
                nextState.D += state.D * matrix.D.D;

                state = nextState;
            }
            return state;
        }

        /**
         * Main function to run the CARVE analysis for a single project.
         * @param {Object} inputData - Data object containing all project inputs.
         * @returns {Object} Final results including score, probabilities, and VaR.
         */
        function runCarveAnalysis(inputData) {
            const carveScore = calculateCarveScore(inputData.scores);
            const transitionMatrix = calculateTransitionMatrix(carveScore);
            const finalState = runMarkovChain(transitionMatrix, inputData.offtakeTerm);

            const probCollapse = finalState.D;
            const probUnderperformance = finalState.U;
            const probOfftakeFailure = probCollapse + probUnderperformance; // U + D
            
            // VaR is calculated as: Contract Value * Probability of Total Collapse
            const valueAtRisk = inputData.contractValue * probCollapse;

            return {
                carveScore: carveScore,
                probCollapse: probCollapse,
                probUnderperformance: probUnderperformance,
                probOfftakeFailure: probOfftakeFailure,
                valueAtRisk: valueAtRisk,
                transitionMatrix: transitionMatrix,
                inputData: inputData
            };
        }

        /**
         * Runs the analysis based on current form data and displays results.
         */
        function runAnalysis() {
            const btn = document.getElementById('runAnalysisBtn');
            const originalText = 'Run Single CARVE-Markov Analysis';
            btn.disabled = true;
            btn.innerHTML = `<div class="loader"></div> Calculating...`;

            try {
                const inputData = getFormData();
                if (!inputData) {
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                    return;
                }

                const results = runCarveAnalysis(inputData);
                window.lastAnalysisData = inputData;
                window.lastAnalysisResults = results;
                
                displaySingleResults(inputData, results);

            } catch (error) {
                console.error("Analysis Error:", error);
                document.getElementById('error-message').innerHTML = `<strong>System Error:</strong> An unexpected error occurred during calculation.`;
                document.getElementById('error-message').classList.remove('hidden');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        /**
         * Displays the results of a single analysis.
         */
        function displaySingleResults(inputData, results) {
            document.getElementById('results-summary').classList.remove('hidden');
            document.getElementById('bulk-results-container').classList.add('hidden');
            document.getElementById('report-output-container').classList.add('hidden');

            document.getElementById('resultProjectName').textContent = inputData.projectName;
            document.getElementById('resultScore').textContent = results.carveScore.toFixed(1) + '/100';
            document.getElementById('resultPCollapse').textContent = (results.probCollapse * 100).toFixed(2) + '%';
            document.getElementById('resultVaR').textContent = '$' + results.valueAtRisk.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            document.getElementById('resultPUnderperf').textContent = (results.probOfftakeFailure * 100).toFixed(2) + '%';
        }

        /**
         * Loads a single sample project's data into the form.
         */
        function loadSampleData() {
            const project = TEST_PROJECTS[0]; // Load Indian Biochar Project by default
            document.getElementById('projectName').value = project[0];
            document.getElementById('offtakeTerm').value = project[1];
            document.getElementById('contractValue').value = project[2];
            document.getElementById('hostCountry').value = project[3];
            document.getElementById('registryScore').value = project[4];
            document.getElementById('informRisk').value = project[5];
            document.getElementById('manualScores').value = project[6].join(', ');
            
            document.getElementById('results-summary').classList.add('hidden');
            document.getElementById('bulk-results-container').classList.add('hidden');
            document.getElementById('report-output-container').classList.add('hidden');
            document.getElementById('error-message').classList.add('hidden');
            console.log(`Loaded sample project: ${project[0]}`);
        }

        /**
         * Runs the CARVE analysis on all 10 test projects and displays a summary table.
         */
        function runBulkAnalysis() {
            const tableBody = document.getElementById('bulk-results-table');
            tableBody.innerHTML = '';
            document.getElementById('results-summary').classList.add('hidden');
            document.getElementById('report-output-container').classList.add('hidden');
            document.getElementById('bulk-results-container').classList.remove('hidden');

            TEST_PROJECTS.forEach(p => {
                const [projectName, term, value, country, registry, inform, manualScores] = p;
                
                // Reconstruct input data for the engine
                const inputData = {
                    projectName,
                    offtakeTerm: term,
                    contractValue: value,
                    hostCountry: country,
                    scores: {
                        financialViability: manualScores[0],
                        devExperienceMethodology: manualScores[1],
                        devExperienceCountry: manualScores[2],
                        methodologyRobustness: manualScores[3],
                        onTimeIssuance: manualScores[4],
                        communityLandTenure: manualScores[5],
                        prePayment: manualScores[6],
                        registry: registry,
                        informRisk: 100 - (inform * 10),
                    }
                };

                const results = runCarveAnalysis(inputData);

                const row = tableBody.insertRow();
                row.className = 'hover:bg-gray-50';
                
                const idCell = row.insertCell();
                idCell.textContent = projectName;
                idCell.className = 'px-3 py-3 whitespace-nowrap text-sm font-medium text-gray-900';

                const scoreCell = row.insertCell();
                scoreCell.textContent = results.carveScore.toFixed(1);
                scoreCell.className = 'px-3 py-3 whitespace-nowrap text-sm text-gray-500';

                const collapseCell = row.insertCell();
                collapseCell.textContent = (results.probCollapse * 100).toFixed(2) + '%';
                collapseCell.className = `px-3 py-3 whitespace-nowrap text-sm ${results.probCollapse > 0.1 ? 'text-red-600 font-semibold' : 'text-green-600'}`;

                const varCell = row.insertCell();
                varCell.textContent = '$' + results.valueAtRisk.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                varCell.className = 'px-3 py-3 whitespace-nowrap text-sm text-gray-500';
            });
        }

        // --- LLM API INTEGRATION FOR REPORT GENERATION ---

        // Exponential backoff utility for retries
        async function fetchWithRetry(url, options, maxRetries = 5) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.ok) return response;
                    
                    if (response.status === 429 && i < maxRetries - 1) {
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                    } else {
                        const error = await response.json();
                        throw new Error(`API failed with status ${response.status}: ${JSON.stringify(error)}`);
                    }
                } catch (error) {
                    if (i === maxRetries - 1) throw error;
                    // Will retry if fetch failed (network error)
                }
            }
        }

        /**
         * Generates the final, narrative report using the LLM API.
         */
        async function generateFullReport() {
            if (!window.lastAnalysisResults) {
                alert("Please run the CARVE-Markov Analysis first.");
                return;
            }

            const btn = document.getElementById('generateReportBtn');
            const originalText = 'Generate Full Report (Powered by Gemini)';
            
            btn.disabled = true;
            btn.innerHTML = `<div class="loader"></div> Generating Report...`;
            document.getElementById('report-output-container').classList.remove('hidden');
            document.getElementById('report-output').innerHTML = '<p class="text-center text-gray-500 mt-10">...Connecting to Gemini API and drafting final report. This may take a moment...</p>';

            const data = window.lastAnalysisData;
            const results = window.lastAnalysisResults;

            // Prepare detailed input data for the LLM
            const inputDetails = `
                --- PROJECT DETAILS ---
                Project Name: ${data.projectName}
                Offtake Term: ${data.offtakeTerm} Years
                Contract Value (USD): ${data.contractValue.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",")}
                Host Country: ${data.hostCountry}

                --- CARVE INPUT SCORES (1-100, Higher is better) ---
                Registry Quality: ${data.scores.registry.toFixed(0)}
                External/INFORM Risk: ${data.scores.informRisk.toFixed(0)} (Derived from raw score of ${data.informRisk})
                Financial Viability: ${data.scores.financialViability.toFixed(0)}
                Developer Experience (Methodology): ${data.scores.devExperienceMethodology.toFixed(0)}
                Developer Experience (Country): ${data.scores.devExperienceCountry.toFixed(0)}
                Methodology Robustness: ${data.scores.methodologyRobustness.toFixed(0)}
                On-Time Issuance History: ${data.scores.onTimeIssuance.toFixed(0)}
                Community/Land Tenure Risk: ${data.scores.communityLandTenure.toFixed(0)}
                Pre-Payment Status: ${data.scores.prePayment.toFixed(0)}

                --- MARKOV CHAIN OUTPUT RESULTS ---
                Final CARVE Score: ${results.carveScore.toFixed(1)}/100
                Probability of Total Collapse (P(D)): ${(results.probCollapse * 100).toFixed(2)}%
                Cumulative Value at Risk (VaR): $${results.valueAtRisk.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",")}
                Probability of Offtake Underperformance (P(U) + P(D)): ${(results.probOfftakeFailure * 100).toFixed(2)}%
                Final P(P): ${(results.transitionMatrix.P.P * 100).toFixed(2)}%
                Final P(U): ${(results.transitionMatrix.P.U * 100).toFixed(2)}%
                Final P(D): ${(results.transitionMatrix.P.D * 100).toFixed(2)}%
            `;

            const systemPrompt = `You are the Chief Climate Scientist and Risk Analyst for the CARVE (Carbon Risk Valuation Engine).
                Your task is to transform the provided raw numerical inputs and Markov Chain results into a professional, narrative Risk Assessment Report.
                The report MUST be delivered entirely in a single Markdown block. Do not use any external formatting (like bolding outside of markdown).
                
                The report MUST follow this exact structure, using the project name and data provided:
                
                # CARVE Portfolio Risk Assessment: [Project Name]
                
                ---
                
                ## 1. Executive Summary & Key Findings
                * Start with a 'Bottom Line Up Front' (BLUF) statement summarizing the overall risk profile (e.g., 'Low Risk,' 'Moderate Risk,' 'High Risk').
                * State the calculated Final CARVE Score (out of 100) and the two key financial metrics: Probability of Total Collapse and Cumulative Value at Risk (VaR).
                
                ## 2. Methodology & Quantitative Metrics
                * Briefly explain that the CARVE Engine quantifies risk across Financial, Technical/Execution, and External factors and uses a probabilistic Markov Chain model to forecast failure over the contract term.
                * Present the three core metrics clearly in a bulleted list.
                
                ## 3. Key Risk Drivers (Qualitative Analysis)
                * Analyze the input scores to identify the 3 strongest risk drivers (highest scores) and the 3 weakest risk drivers (lowest scores).
                * For each driver, provide a brief, professional interpretation (e.g., "High score in Methodology Robustness indicates strong permanence.").
                
                ## 4. Confidence and Comparative Assessment
                * Provide a standard **85% Confidence Score** in the model's accuracy, stating that the model's primary value is in comparing projects across a portfolio.
                * Include the standard statement: "This project is currently expected to perform within the upper-middle quartile of similar projects globally, provided the core risk drivers identified remain stable."
                
                ## 5. Standard Terms and Conditions
                * The report MUST end with the full text of the following legal disclaimer, preceded by a horizontal rule:
                ---
                **Standard Terms and Conditions**
                This CARVE Portfolio Risk Assessment is provided for informational and internal comparative purposes only. It is the result of a proprietary Markov Chain forecasting model and does not constitute investment advice, legal counsel, or a guarantee of future project performance. The model relies on internal scoring inputs which are estimations based on publicly available data, proprietary research, and professional judgment. Climate Risk Analysis makes no representations or warranties, express or implied, regarding the accuracy, completeness, or reliability of the information contained herein. The recipient assumes sole responsibility for all decisions and outcomes based on the use of this report. Climate Risk Analysis shall not be liable for any direct, indirect, incidental, or consequential damages resulting from the use or interpretation of this assessment.
            `;

            const userQuery = `Generate the full risk assessment report using the following raw data. Ensure all numerical results are smoothly integrated into the narrative and that the final output is a single, complete Markdown block. \n\n${inputDetails}`;

            const apiKey = ""; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            try {
                const response = await fetchWithRetry(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text || "Error: Could not generate report content.";
                
                document.getElementById('report-output').innerHTML = text;
                console.log(`Report generation successful for ${data.projectName}.`);

                // NOTE: In the live canvas environment, this triggers a file to be generated.
                
            } catch (error) {
                console.error("API Call failed:", error);
                document.getElementById('report-output').innerHTML = `<p class="text-red-500">Failed to generate report due to API error. Check the console for details: ${error.message}</p>`;
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        // Initialize Global Objects
        window.lastAnalysisData = null;
        window.lastAnalysisResults = null;

        /**
         * Runs the CARVE analysis on all 10 test projects and displays a summary table.
         * The results are displayed in the UI, but the analysis is run in the console.
         */
        function runInitialSetup() {
            // Check for runAnalysis in the URL hash, this simulates the initial action
            if (window.location.hash === '#run') {
                loadSampleData();
                runAnalysis();
                runBulkAnalysis();
            } else {
                loadSampleData();
                runBulkAnalysis(); // Run bulk analysis on load to show portfolio context
            }
        }

        window.onload = runInitialSetup;


    </script>
</body>
</html>
