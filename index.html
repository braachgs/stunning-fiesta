<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CARVE-Markov Risk Engine</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fb; }
        .card { background-color: white; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06); padding: 24px; }
        .input-group label { font-weight: 600; color: #333; }
        .input-manual { background-color: #fff; border: 2px solid #3b82f6; } /* Expert Input */
        .input-automated { background-color: #f0f4f8; border: 1px solid #cbd5e1; color: #4a5568; } /* CDOP/Automated */
        .input-manual:focus { border-color: #2563eb; ring-color: #bfdbfe; }
        .btn-primary { background-color: #10b981; color: white; transition: background-color 0.2s; }
        .btn-primary:hover { background-color: #059669; }
        .btn-secondary { background-color: #3b82f6; color: white; transition: background-color 0.2s; }
        .btn-secondary:hover { background-color: #2563eb; }
        .result-box { background-color: #ecfdf5; border-left: 5px solid #10b981; padding: 16px; border-radius: 8px; margin-top: 20px; }
        .result-box p { margin: 0; }
        .result-value { font-weight: 700; color: #065f46; font-size: 1.125rem; }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen">

    <div class="max-w-6xl mx-auto">
        
        <header class="mb-6 flex justify-between items-center">
            <h1 class="text-3xl font-bold text-gray-800">CARVE-Markov Engine</h1>
            <button id="helpButton" class="text-sm font-semibold text-gray-600 hover:text-gray-800 py-1 px-3 border border-gray-300 rounded-full transition duration-150">
                View Help & Data Guide
            </button>
        </header>

        <!-- Help Documentation Modal -->
        <div id="helpModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center p-4 z-50">
            <div class="card max-w-2xl w-full">
                <h2 class="text-2xl font-bold mb-4 border-b pb-2">CARVE Gem Documentation & Data Guide</h2>
                <p class="text-sm mb-4 text-gray-700">This guide explains the **Hybrid Scoring Model** and provides IDs for testing the automated data pipeline.</p>
                
                <h3 class="font-semibold text-lg mb-2">Hybrid Input Model</h3>
                <p class="text-xs mb-4">The CARVE Engine combines **Automated CDOP/INFORM Data** (gray fields) with your **Manual Expert Scores** (white fields) for a single, auditable risk score. The final report includes an Audit Annex detailing the source of every score.</p>
                
                <h3 class="font-semibold text-lg mb-2">Simulated CDOP Projects (Use these IDs for lookup)</h3>
                <div class="overflow-x-auto mb-6">
                    <table class="min-w-full text-sm text-gray-600 bg-gray-50 rounded-lg">
                        <thead>
                            <tr class="text-left text-gray-800 border-b">
                                <th class="p-2 font-bold">Project ID</th>
                                <th class="p-2 font-bold">Project Type</th>
                                <th class="p-2 font-bold">Host Country</th>
                                <th class="p-2 font-bold">Risk Profile</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td class="p-2">001-AFOLU-US</td><td class="p-2">AFOLU</td><td class="p-2">United States</td><td class="p-2">Low Risk</td></tr>
                            <tr><td class="p-2">002-ENGINEERED-CH</td><td class="p-2">Engineered</td><td class="p-2">Switzerland</td><td class="p-2">Very Low Risk</td></tr>
                            <tr><td class="p-2">003-AFOLU-CO</td><td class="p-2">AFOLU</td><td class="p-2">Colombia</td><td class="p-2">Medium Risk</td></tr>
                            <tr><td class="p-2">004-AFOLU-SL</td><td class="p-2">AFOLU</td><td class="p-2">Sierra Leone</td><td class="p-2">High Risk</td></tr>
                            <tr><td class="p-2">005-BLUECARBON-ID</td><td class="p-2">Blue Carbon</td><td class="p-2">Indonesia</td><td class="p-2">High Risk</td></tr>
                        </tbody>
                    </table>
                </div>

                <div class="flex justify-end">
                    <button id="closeHelpButton" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Close</button>
                </div>
            </div>
        </div>
        
        <div id="error-message" class="hidden p-4 mb-4 text-sm text-red-800 bg-red-100 rounded-lg" role="alert"></div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Input Form - Left Column (lg:col-span-2) -->
            <div class="lg:col-span-2 card">
                <h2 class="text-2xl font-bold mb-6 border-b pb-2">Offtake Agreement Inputs</h2>
                
                <form id="carveForm">
                    <!-- Automated Data Simulation -->
                    <div class="mb-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
                        <label class="block mb-2 text-sm font-bold text-blue-700">AUTOMATED DATA IMPORT (CDOP Simulation)</label>
                        <p class="text-xs text-blue-600 mb-3">Enter a simulated Project ID (e.g., 001-AFOLU-US) to pull automated Registry and INFORM risk scores.</p>
                        <input type="text" id="cdop_project_id" value="001-AFOLU-US" placeholder="e.g., 001-AFOLU-US" class="input-automated w-full p-2 border rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>

                    <!-- Financial Inputs -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div class="input-group">
                            <label for="project_name" class="block text-sm">Project Name / ID</label>
                            <input type="text" id="project_name" value="AFOLU US Sample" class="input-automated w-full p-2 border rounded-lg" readonly>
                        </div>
                         <div class="input-group">
                            <label for="offtake_term" class="block text-sm">Offtake Term (Years)</label>
                            <input type="number" id="offtake_term" value="5" class="input-manual w-full p-2 border rounded-lg" required>
                        </div>
                        <div class="input-group">
                            <label for="contract_value" class="block text-sm">Total Contract Value (USD)</label>
                            <input type="number" id="contract_value" value="2000000" class="input-manual w-full p-2 border rounded-lg" required>
                        </div>
                    </div>

                    <!-- Host Country and Registry (Automated Display) -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <div class="input-group">
                            <label for="host_country" class="block text-sm">Host Country (CDOP)</label>
                            <input type="text" id="host_country" value="United States" class="input-automated w-full p-2 border rounded-lg" readonly>
                        </div>
                         <div class="input-group">
                            <label for="registry_score" class="block text-sm">Registry Score (CDOP) - Scale: 1-100</label>
                            <input type="number" id="registry_score" value="90" class="input-automated w-full p-2 border rounded-lg" readonly>
                        </div>
                    </div>

                    <!-- Manual CARVE Scores Input (Expert Judgment) -->
                    <div class="input-group mb-6">
                        <label for="manual_scores" class="block text-sm">MANUAL CARVE SCORE INPUT (7 Scores, Comma-Separated)</label>
                        <p class="text-xs text-gray-500 mb-2">Input 7 scores (1-100) in this exact order: Financial Viability, Legal Structure, Community Risk, Methodology Robustness, On-Time Issuance History, Developer Experience, Pre-Payment Risk.</p>
                        <textarea id="manual_scores" rows="3" class="input-manual w-full p-2 border rounded-lg" placeholder="e.g., 65, 80, 75, 95, 40, 70, 90">65, 80, 75, 95, 40, 70, 90</textarea>
                    </div>

                    <!-- Buttons -->
                    <div class="flex flex-col md:flex-row gap-4">
                        <button type="submit" id="runAnalysisButton" class="btn-primary flex-grow px-6 py-3 rounded-lg text-lg font-semibold hover:shadow-lg">
                            Run Single CARVE-Markov Analysis
                        </button>
                        <button type="button" id="loadSampleButton" class="btn-secondary px-6 py-3 rounded-lg font-semibold">
                            Load Single Sample Project
                        </button>
                    </div>
                </form>

            </div>

            <!-- Results & Demo - Right Column -->
            <div class="card lg:col-span-1">
                <h2 class="text-2xl font-bold mb-6 border-b pb-2">Results & Portfolio Demo</h2>

                <div id="results-display" class="hidden">
                    <div class="result-box">
                        <p class="text-sm font-semibold text-gray-700">Calculated CARVE Risk Score</p>
                        <p class="result-value" id="final-score">--</p>
                    </div>
                    <div class="result-box mt-4">
                        <p class="text-sm font-semibold text-gray-700">Cumulative Value at Risk (VaR)</p>
                        <p class="result-value" id="final-var">--</p>
                    </div>
                    <div class="result-box mt-4">
                        <p class="text-sm font-semibold text-gray-700">Probability of Total Collapse (Default)</p>
                        <p class="result-value" id="final-collapse">--</p>
                    </div>

                    <button type="button" id="generateReportButton" class="mt-6 w-full px-6 py-3 rounded-lg text-lg font-semibold bg-gray-700 text-white hover:bg-gray-800 transition duration-150">
                        Generate Full Auditable Report
                    </button>
                </div>
                
                <p id="initial-message" class="text-gray-500 italic mb-4">Run an analysis above or use the portfolio demo below.</p>
                
                <button type="button" id="runBulkButton" class="w-full px-6 py-3 rounded-lg text-lg font-semibold bg-gray-500 text-white hover:bg-gray-600 transition duration-150 mt-4">
                    Run Bulk Analysis (5 Simulated CDOP Projects)
                </button>
                
                <div id="bulk-results" class="mt-6 text-sm">
                    <p class="font-semibold mb-2">Portfolio Cross-Validation Summary:</p>
                    <!-- Bulk results table will be injected here -->
                </div>
            </div>
        </div>

        <!-- Report Output Section -->
        <div class="mt-8 card hidden" id="report-output-section">
            <h2 class="text-2xl font-bold mb-4 border-b pb-2">Generated Report Output (Markdown)</h2>
            <div id="report-output" class="p-4 bg-gray-100 rounded-lg whitespace-pre-wrap text-sm" style="max-height: 600px; overflow-y: auto;">
                <!-- LLM Report will be injected here -->
            </div>
        </div>

    </div>

    <script type="module">
        // --- 1. CONFIGURATION AND UTILITIES ---

        const LLM_API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=";
        const TEST_PROJECTS = [
            // Note: We use the 10 legacy projects for the BULK demo, and the 5 simulated projects for the CDOP demo.
            { id: "legacy-1", name: "Indian Biochar Project", term: 5, value: 2000000, country: "India", informalRisk: 5.6, registryScore: 90, manualScores: [65, 80, 75, 95, 40, 70, 90] },
            { id: "legacy-2", name: "BECCS (VCS5212)", term: 5, value: 17920128, country: "Denmark", informalRisk: 2.1, registryScore: 80, manualScores: [85, 90, 95, 85, 90, 85, 80] },
            { id: "legacy-3", name: "AFOLU (VCS1378)", term: 10, value: 15181287, country: "Colombia", informalRisk: 5.3, registryScore: 80, manualScores: [85, 85, 70, 75, 60, 65, 80] },
            { id: "legacy-4", name: "DAC (VCS5525)", term: 7, value: 7927812, country: "United States", informalRisk: 3.2, registryScore: 80, manualScores: [95, 90, 95, 90, 85, 95, 90] },
            { id: "legacy-5", name: "HFC (ACR945)", term: 3, value: 1584063, country: "United States", informalRisk: 3.2, registryScore: 75, manualScores: [90, 95, 95, 95, 95, 90, 90] },
        ];

        // --- Simulated CDOP Database for Hybrid Scoring ---
        const SIMULATED_CDOP_DATABASE = {
            "001-AFOLU-US": { name: "US AFOLU Project (VCS)", country: "United States", registryScore: 80, informalRisk: 3.2, description: "Standard US-based reforestation project. Low external risk, moderate issuance history." },
            "002-ENGINEERED-CH": { name: "Swiss Engineered DAC (Puro)", country: "Switzerland", registryScore: 90, informalRisk: 1.9, description: "High-integrity, Puro-registered DAC project. Extremely low external risk." },
            "003-AFOLU-CO": { name: "Colombian AFOLU (GS)", country: "Colombia", registryScore: 85, informalRisk: 5.3, description: "Gold Standard AFOLU project. Moderate political and natural hazard risk." },
            "004-AFOLU-SL": { name: "Sierra Leone AFOLU (VCS)", country: "Sierra Leone", registryScore: 80, informalRisk: 7.8, description: "VCS Reforestation project. Very high INFORM risk and political instability." },
            "005-BLUECARBON-ID": { name: "Indonesian Blue Carbon (VCS)", country: "Indonesia", registryScore: 80, informalRisk: 6.1, description: "VCS Blue Carbon project. High exposure to natural hazards and regulatory change." },
        };
        
        // Markov Chain Transition Matrix Weights (Expert-defined)
        // P=Performing, U=Under-delivering, D=Default
        // The scores (1-100) are mapped to a single transition probability.
        const TRANSITION_WEIGHTS = {
            // Base Transition P -> U (Higher score = lower risk of transition)
            P_TO_U: 0.05, 
            // Base Transition U -> D (Higher score = lower risk of terminal default)
            U_TO_D: 0.08,
            // Base Retention P -> P (Higher score = higher retention rate)
            P_TO_P: 0.95 
        };

        /**
         * Fills the form with a single sample project's data.
         * @param {Object} projectData - Data to load.
         */
        function loadSampleData(projectData = null) {
            const defaultId = "legacy-1";
            let data = projectData || TEST_PROJECTS.find(p => p.id === defaultId);
            
            // For the single sample load, we use a legacy project that is NOT in the CDOP DB.
            document.getElementById('cdop_project_id').value = ''; 
            document.getElementById('project_name').value = data.name;
            document.getElementById('offtake_term').value = data.term;
            document.getElementById('contract_value').value = data.value;
            document.getElementById('host_country').value = data.country;
            document.getElementById('registry_score').value = data.registryScore;

            // Manual scores
            document.getElementById('manual_scores').value = data.manualScores.join(', ');
        }

        /**
         * Pulls data from the form and validates inputs. Includes CDOP/Hybrid logic.
         * @returns {Object|null} The clean form data or null if validation fails.
         */
        function getFormData() {
            const form = document.getElementById('carveForm');
            const data = {};
            
            data.cdopId = form.cdop_project_id.value.trim();
            data.term = parseInt(form.offtake_term.value);
            data.value = parseFloat(form.contract_value.value);
            data.manualScoresStr = form.manual_scores.value.trim();
            
            data.auditLog = {}; // Initialize the audit log

            // --- 1. Data Validation ---
            let errors = [];
            
            // Check essential fields
            if (!data.term || data.term <= 0 || isNaN(data.term)) errors.push("Offtake Term (Years) must be a positive number.");
            if (!data.value || data.value <= 0 || isNaN(data.value)) errors.push("Total Contract Value (USD) must be a positive number.");
            
            // Check manual scores
            const scores = data.manualScoresStr.split(',').map(s => parseFloat(s.trim()));
            if (scores.length !== 7 || scores.some(isNaN) || scores.some(s => s < 1 || s > 100)) {
                errors.push("Manual Scores must be 7 comma-separated numbers between 1 and 100.");
            }
            data.manualScores = scores;
            
            // --- 2. CDOP/Hybrid Data Pull ---
            let automatedData = null;
            if (data.cdopId && SIMULATED_CDOP_DATABASE[data.cdopId]) {
                automatedData = SIMULATED_CDOP_DATABASE[data.cdopId];
                document.getElementById('project_name').value = automatedData.name;
                document.getElementById('host_country').value = automatedData.country;
                document.getElementById('registry_score').value = automatedData.registryScore;
            } else if (data.cdopId) {
                errors.push(`CDOP Project ID "${data.cdopId}" not found in simulated database.`);
            }
            
            if (errors.length > 0) {
                displayError(errors.join('<br>'));
                return null;
            }
            
            // --- 3. Final Scoring Inputs & Audit Trail Population ---
            
            // Manual Scores (Tier III - Expert Judgment)
            data.financialViabilityScore = scores[0];
            data.legalStructureScore = scores[1];
            data.communityRiskScore = scores[2];
            data.methodologyRobustnessScore = scores[3];
            data.onTimeIssuanceScore = scores[4];
            data.developerExperienceScore = scores[5];
            data.prePaymentRiskScore = scores[6];
            
            // Automated Scores (Tier I & II - CDOP/INFORM)
            data.registryScore = parseFloat(document.getElementById('registry_score').value);
            data.informRisk = automatedData ? automatedData.informRisk : 5.6; // Default if not CDOP
            data.country = document.getElementById('host_country').value;
            
            // Populate Audit Log
            data.auditLog["Registry Score (Tier II)"] = { value: data.registryScore, source: automatedData ? 'CDOP Simulation' : 'Manual Default' };
            data.auditLog["External INFORM Risk (Tier I)"] = { value: data.informRisk, source: automatedData ? 'CDOP Simulation' : 'Manual Default' };
            data.auditLog["Financial Viability Score"] = { value: data.financialViabilityScore, source: 'Expert Analyst Input' };
            data.auditLog["Legal Structure Score"] = { value: data.legalStructureScore, source: 'Expert Analyst Input' };
            data.auditLog["Community Risk Score"] = { value: data.communityRiskScore, source: 'Expert Analyst Input' };
            data.auditLog["Methodology Robustness Score"] = { value: data.methodologyRobustnessScore, source: 'Expert Analyst Input' };
            data.auditLog["On-Time Issuance History Score"] = { value: data.onTimeIssuanceScore, source: 'Expert Analyst Input' };
            data.auditLog["Developer Experience Score"] = { value: data.developerExperienceScore, source: 'Expert Analyst Input' };
            data.auditLog["Pre-Payment Risk Score"] = { value: data.prePaymentRiskScore, source: 'Expert Analyst Input' };

            return data;
        }

        /**
         * Calculates the CARVE Score and Markov Chain probabilities.
         * @param {Object} data - Clean form data.
         * @returns {Object} Analysis results.
         */
        function calculateCarveScore(data) {
            // --- 1. Weighted CARVE Score (1-100) ---
            
            // Sub-Tier III: Execution (50% of total CARVE)
            const executionScores = [
                data.financialViabilityScore, data.legalStructureScore, data.communityRiskScore, 
                data.onTimeIssuanceScore, data.developerExperienceScore, data.prePaymentRiskScore
            ];
            const executionWeights = [0.15, 0.05, 0.10, 0.25, 0.15, 0.30]; // Sums to 1.0
            let executionScore = executionScores.reduce((sum, score, i) => sum + (score * executionWeights[i]), 0);

            // Tier III: Methodology (20% of total CARVE)
            const methodologyScore = data.methodologyRobustnessScore;

            // Tier I: External Risk (15% of total CARVE - Converted from INFORM 1-10 to 1-100)
            const informToCarve = 100 - (data.informRisk * 10); // 1.0 INFORM = 90 CARVE, 8.0 INFORM = 20 CARVE
            const externalScore = informToCarve > 0 ? informToCarve : 1; 

            // Tier II: Registry Risk (15% of total CARVE)
            const registryScore = data.registryScore;

            // Final Blended CARVE Score (Tier III: 70%, Tier I: 15%, Tier II: 15%)
            const finalCarveScore = (executionScore * 0.50) + (methodologyScore * 0.20) + (externalScore * 0.15) + (registryScore * 0.15);
            
            // --- 2. Markov Chain Probability Calculation ---
            
            // Map CARVE score (60-100 range is typical) to risk adjustment factor (0.5 to 1.5)
            // Lower CARVE score = Higher risk multiplier
            const riskMultiplier = 1.5 - ((finalCarveScore - 60) / 40) * 1.0; 
            const multiplier = Math.max(0.5, Math.min(1.5, riskMultiplier));

            const term = data.term;
            
            // Transition Probability Adjustments
            let p_to_u = TRANSITION_WEIGHTS.P_TO_U * multiplier;
            let u_to_d = TRANSITION_WEIGHTS.U_TO_D * multiplier;
            
            // Ensure probabilities sum correctly and remain realistic
            p_to_u = Math.min(p_to_u, 0.5); 
            u_to_d = Math.min(u_to_d, 0.5); 

            // Calculate Transition Matrix M
            const p_to_p = 1.0 - p_to_u; // P-to-P = 1 - P-to-U
            const u_to_u = 1.0 - u_to_d; // U-to-U = 1 - U-to-D
            
            const M = [
                [p_to_p, p_to_u, 0.0],  // P row
                [0.0, u_to_u, u_to_d],  // U row
                [0.0, 0.0, 1.0]         // D row (Absorbing State)
            ];

            // Initial state vector V0 = [1.0, 0.0, 0.0] (Starts in Performing)
            let V = [1.0, 0.0, 0.0];

            // Calculate Vn = V0 * M^n
            for (let t = 0; t < term; t++) {
                let newV = [0, 0, 0];
                newV[0] = V[0] * M[0][0] + V[1] * M[1][0] + V[2] * M[2][0];
                newV[1] = V[0] * M[0][1] + V[1] * M[1][1] + V[2] * M[2][1];
                newV[2] = V[0] * M[0][2] + V[1] * M[1][2] + V[2] * M[2][2];
                V = newV;
            }

            const p_collapse = V[2];
            const p_underperform = V[1];
            
            // Value at Risk (VaR) = Total Contract Value * P(Collapse)
            const varResult = data.value * p_collapse;

            return {
                carveScore: finalCarveScore.toFixed(1),
                pCollapse: (p_collapse * 100).toFixed(2),
                pUnderperform: (p_underperform * 100).toFixed(2),
                varResult: varResult.toFixed(0),
                pPerforming: (V[0] * 100).toFixed(2),
                p_to_u: (p_to_u * 100).toFixed(2),
                u_to_d: (u_to_d * 100).toFixed(2),
                M: M // Return matrix for reporting
            };
        }

        /**
         * Renders the analysis results to the display area.
         * @param {Object} results - The results object from calculateCarveScore.
         * @param {Object} data - The input data object.
         */
        function displayResults(results, data) {
            document.getElementById('initial-message').classList.add('hidden');
            document.getElementById('results-display').classList.remove('hidden');

            document.getElementById('final-score').textContent = `${results.carveScore} / 100`;
            document.getElementById('final-collapse').textContent = `${results.pCollapse}%`;
            document.getElementById('final-var').textContent = `$${parseInt(results.varResult).toLocaleString()}`;
            
            // Store results for report generation
            window.lastAnalysisData = data;
            window.lastAnalysisResults = results;
        }

        /**
         * Clears errors.
         */
        function clearError() {
            const errorElement = document.getElementById('error-message');
            errorElement.classList.add('hidden');
            errorElement.innerHTML = '';
        }

        /**
         * Displays validation errors.
         * @param {string} message - Error message HTML.
         */
        function displayError(message) {
            const errorElement = document.getElementById('error-message');
            errorElement.classList.remove('hidden');
            errorElement.innerHTML = `<strong>Input Error:</strong><br>${message}`;
        }

        /**
         * Main function to run a single CARVE analysis.
         */
        function runAnalysis() {
            clearError();
            const data = getFormData();
            if (!data) return;

            const results = calculateCarveScore(data);
            displayResults(results, data);
            
            // Hide report output if a new analysis is run
            document.getElementById('report-output-section').classList.add('hidden');
        }

        /**
         * Runs the analysis on all 5 CDOP simulated projects for portfolio view.
         */
        function runBulkAnalysis() {
            const bulkResultsDiv = document.getElementById('bulk-results');
            const contractValue = 10000000; // Use a standardized $10M for comparison

            let tableHtml = `<table class="min-w-full text-xs text-gray-600"><thead><tr class="text-left text-gray-800 border-b">
                <th class="p-2 font-bold">Project ID</th>
                <th class="p-2 font-bold">Country</th>
                <th class="p-2 font-bold">CARVE Score</th>
                <th class="p-2 font-bold">P(Collapse)</th>
                <th class="p-2 font-bold">VaR (USD)</th>
            </tr></thead><tbody>`;
            
            // Use a consistent set of Manual Scores for the demo to isolate CDOP/INFORM risk impact
            const moderateManualScores = "85, 80, 75, 75, 70, 70, 80"; 

            for (const id in SIMULATED_CDOP_DATABASE) {
                const automatedData = SIMULATED_CDOP_DATABASE[id];
                
                // Construct a mock data object for calculation
                const data = {
                    cdopId: id,
                    term: 7, // Standardized 7-year term for portfolio comparison
                    value: contractValue,
                    manualScoresStr: moderateManualScores,
                    manualScores: moderateManualScores.split(',').map(s => parseFloat(s.trim())),
                    registryScore: automatedData.registryScore,
                    informRisk: automatedData.informRisk,
                    country: automatedData.country,
                    // Tier III Manual Scores (consistent)
                    financialViabilityScore: 85, legalStructureScore: 80, communityRiskScore: 75, 
                    methodologyRobustnessScore: 75, onTimeIssuanceScore: 70, developerExperienceScore: 70, 
                    prePaymentRiskScore: 80,
                    auditLog: {} // Not needed for bulk table view
                };
                
                const results = calculateCarveScore(data);
                
                tableHtml += `<tr>
                    <td class="p-2">${id}</td>
                    <td class="p-2">${data.country}</td>
                    <td class="p-2 font-bold">${results.carveScore}</td>
                    <td class="p-2">${results.pCollapse}%</td>
                    <td class="p-2">$${parseInt(results.varResult).toLocaleString()}</td>
                </tr>`;
            }
            
            tableHtml += `</tbody></table>`;
            bulkResultsDiv.innerHTML = tableHtml;
        }


        /**
         * Formats the audit log object into a clean Markdown string for the LLM.
         * @param {Object} auditLog - The audit log object.
         * @returns {string} Markdown formatted audit trail.
         */
        function formatAuditLog(auditLog) {
            let markdown = "### Data Sourcing Audit Trail\n";
            markdown += "The following table details the source for each factor used in the CARVE score calculation:\n\n";
            markdown += "| CARVE Factor | Source | Value |\n";
            markdown += "| :--- | :--- | :--- |\n";

            for (const factor in auditLog) {
                const entry = auditLog[factor];
                const value = typeof entry.value === 'number' ? entry.value.toFixed(1) : entry.value;
                markdown += `| ${factor} | ${entry.source} | ${value} |\n`;
            }
            return markdown;
        }

        /**
         * Calls the Gemini API to generate the full report.
         */
        async function generateFinalReport() {
            if (!window.lastAnalysisData || !window.lastAnalysisResults) {
                document.getElementById('report-output').textContent = "Please run an analysis first.";
                return;
            }

            const data = window.lastAnalysisData;
            const results = window.lastAnalysisResults;
            const auditTrailMarkdown = formatAuditLog(data.auditLog);

            const btn = document.getElementById('generateReportButton');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = 'Generating Report...';
            document.getElementById('report-output-section').classList.remove('hidden');
            document.getElementById('report-output').textContent = 'Requesting LLM Analysis and Formatting...';
            
            const systemPrompt = `You are the Chief Climate Scientist for Climate Risk Analysis. Your goal is to convert numerical CARVE-Markov risk modeling results into a professional, auditable financial risk report suitable for a corporate CFO audience.
            
            STRICT OUTPUT INSTRUCTIONS:
            1. Report MUST be titled "CARVE Portfolio Risk Assessment: ${data.project_name}".
            2. Use Markdown format exclusively.
            3. The report must contain these sections in this exact order: "1. Executive Summary", "2. Project Profile and Hybrid Score", "3. Markov Chain Financial Forecast", "4. Key Risk Drivers", "5. Terms and Conditions", and the final "Annex: Data Sourcing and Audit Trail".
            4. The tone must be authoritative, objective, and financially focused.
            5. Incorporate the Audit Trail provided in the user prompt into the final "Annex" section.`;
            
            // --- User Query: The full dataset for the LLM ---
            const userQuery = `Generate a financial risk report for the project "${data.project_name}" based on the following data points for a ${data.term}-year offtake:
            
            --- PROJECT DATA ---
            - Host Country: ${data.country}
            - Total Contract Value: $${data.value.toLocaleString()}
            - Offtake Term: ${data.term} years
            - Final CARVE Score: ${results.carveScore}/100

            --- NUMERICAL RESULTS ---
            - Cumulative Value at Risk (VaR): $${results.varResult.toLocaleString()}
            - Probability of Total Project Collapse (Default): ${results.pCollapse}%
            - Probability of Offtake Underperformance (U): ${results.pUnderperform}%
            - Transition P→U (Performing to Under-delivering): ${results.p_to_u}%
            - Transition U→D (Under-delivering to Default): ${results.u_to_d}%

            --- AUDIT TRAIL DATA ---
            Use this data for the final Annex, providing transparency on automated vs. manual inputs:
            ${auditTrailMarkdown}`;


            // --- API Call Logic with Exponential Backoff ---
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            const apiKey = "";
            const apiUrl = LLM_API_URL + apiKey;

            // Exponential Backoff Implementation
            let response;
            const maxRetries = 3;
            for (let i = 0; i < maxRetries; i++) {
                try {
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (response.status === 429) {
                        const delay = Math.pow(2, i) * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue; 
                    }
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    break;
                } catch (error) {
                    if (i === maxRetries - 1) throw error; 
                    const delay = Math.pow(2, i) * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }

            try {
                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text || "Error: Could not generate report content.";
                
                document.getElementById('report-output').textContent = text;
            } catch (error) {
                console.error("API Call failed:", error);
                document.getElementById('report-output').textContent = `Failed to generate report due to API error. Check the console for details: ${error.message}`;
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        // --- 3. EVENT LISTENERS AND INITIAL SETUP ---

        /**
         * Initializes event listeners and sets up the initial state.
         */
        function initialSetup() {
            // Store results globally for report generation
            window.lastAnalysisData = null;
            window.lastAnalysisResults = null;

            document.getElementById('carveForm').addEventListener('submit', function(e) {
                e.preventDefault();
                runAnalysis();
            });

            document.getElementById('loadSampleButton').addEventListener('click', function() {
                loadSampleData(TEST_PROJECTS[0]);
                runAnalysis(); 
            });
            
            document.getElementById('generateReportButton').addEventListener('click', generateFinalReport);
            document.getElementById('runBulkButton').addEventListener('click', runBulkAnalysis);
            
            // Help Modal Handlers
            document.getElementById('helpButton').addEventListener('click', () => {
                document.getElementById('helpModal').classList.remove('hidden');
                document.getElementById('helpModal').classList.add('flex');
            });

            document.getElementById('closeHelpButton').addEventListener('click', () => {
                document.getElementById('helpModal').classList.remove('flex');
                document.getElementById('helpModal').classList.add('hidden');
            });

            // Initial load of a sample project and bulk demo on page load
            loadSampleData(SIMULATED_CDOP_DATABASE["001-AFOLU-US"]);
            runBulkAnalysis();
        }

        // Run the setup when the page loads
        window.onload = initialSetup;


        
    </script>
</body>
</html>
