<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CARVE-Markov Risk Engine</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fb; }
        .card { background-color: white; border-radius: 12px; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .score-box { background-color: #eff6ff; border: 1px solid #bfdbfe; color: #1e40af; }
        .input-manual { background-color: #ffffff; }
        .input-automated { background-color: #f3f4f6; border-left: 4px solid #9ca3af; }
        /* Simple modal styles */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.6); display: none; justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-content {
            background-color: white; padding: 30px; border-radius: 12px; max-width: 700px; max-height: 90vh; overflow-y: auto;
            position: relative;
        }
    </style>
</head>
<body class="p-4 sm:p-8">
    <div class="max-w-6xl mx-auto">
        <header class="mb-8">
            <h1 class="text-3xl font-extrabold text-gray-900">CARVE-Markov Risk Engine</h1>
            <p class="text-gray-500">Hybrid Financial Risk Modeling for VCM Offtake Agreements</p>
        </header>

        <!-- Help Modal -->
        <div id="helpModal" class="modal">
            <div class="modal-content">
                <button id="closeModalBtn" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-xl font-bold">&times;</button>
                <h2 class="text-2xl font-bold mb-4 text-gray-800">CARVE Gem: Data Guide & Testing</h2>
                <p class="text-sm mb-6 text-gray-600">The CARVE Engine uses a **Hybrid Scoring Model**, blending **Automated Data (CDOP)** for baseline factors with your **Manual Scores** for proprietary execution risk.</p>

                <h3 class="text-xl font-semibold mt-4 mb-2 text-gray-700">1. Automated Data Lookup (Simulated CDOP Database)</h3>
                <p class="text-sm mb-4 text-gray-600">Enter a Project ID below to automatically populate **External** and **Registry** scores. **These are the only IDs currently in the simulated database:**</p>

                <div class="overflow-x-auto card p-4 mb-6">
                    <table class="min-w-full text-xs text-left text-gray-500">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                            <tr>
                                <th scope="col" class="px-3 py-2">ID</th>
                                <th scope="col" class="px-3 py-2">Project Type</th>
                                <th scope="col" class="px-3 py-2">Host Country</th>
                                <th scope="col" class="px-3 py-2">INFORM Score</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="bg-white border-b"><td class="px-3 py-2 font-medium text-gray-900">001-AFOLU-US</td><td class="px-3 py-2">AFOLU</td><td class="px-3 py-2">United States</td><td class="px-3 py-2">3.2</td></tr>
                            <tr class="bg-gray-50 border-b"><td class="px-3 py-2 font-medium text-gray-900">002-ENGINEERED-CH</td><td class="px-3 py-2">Engineered</td><td class="px-3 py-2">Switzerland</td><td class="px-3 py-2">2.1</td></tr>
                            <tr class="bg-white border-b"><td class="px-3 py-2 font-medium text-gray-900">003-AFOLU-CO</td><td class="px-3 py-2">AFOLU</td><td class="px-3 py-2">Colombia</td><td class="px-3 py-2">5.3</td></tr>
                            <tr class="bg-gray-50 border-b"><td class="px-3 py-2 font-medium text-gray-900">004-AFOLU-SL</td><td class="px-3 py-2">AFOLU</td><td class="px-3 py-2">Sierra Leone</td><td class="px-3 py-2">7.8</td></tr>
                            <tr class="bg-white"><td class="px-3 py-2 font-medium text-gray-900">005-BLUECARBON-ID</td><td class="px-3 py-2">Blue Carbon</td><td class="px-3 py-2">Indonesia</td><td class="px-3 py-2">6.1</td></tr>
                        </tbody>
                    </table>
                </div>

                <h3 class="text-xl font-semibold mt-4 mb-2 text-gray-700">2. Manual Score Input (Tier III - Expert Judgment)</h3>
                <p class="text-sm text-gray-600">The most predictive risk factors require your expertise. These 7 scores must be entered manually as a comma-separated string (1-100 range). The order matters:</p>
                <code class="block bg-gray-100 p-3 rounded-md mt-2 text-xs font-mono">1. Financial Viability, 2. Financial Viability (Pre-Payment), 3. Community Risk, 4. Methodology/Robustness, 5. On-Time Issuance History, 6. Community Risk (Political), 7. Community Risk (Social)</code>

                <h3 class="text-xl font-semibold mt-4 mb-2 text-gray-700">3. Auditability</h3>
                <p class="text-sm text-gray-600">The final report includes an **Audit Trail** annex, clearly defining which scores were **Automated (CDOP)** and which were **Manual (Expert Analyst Input)**, ensuring full transparency.</p>
            </div>
        </div>
        
        <!-- Main Application Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Input Form (Col 1) -->
            <div class="lg:col-span-2 card p-6">
                <div id="error-message" class="hidden p-3 mb-4 text-sm text-red-700 bg-red-100 rounded-lg" role="alert"></div>

                <form id="carveForm">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-semibold text-gray-800">Project Inputs</h2>
                        <button type="button" id="openModalBtn" class="text-blue-600 hover:text-blue-800 text-sm font-medium focus:outline-none">
                            View Help & Data Guide
                        </button>
                    </div>

                    <!-- Automated Data Input -->
                    <div class="mb-6 p-4 rounded-lg bg-gray-50 border border-gray-200">
                        <h3 class="text-lg font-semibold mb-3 text-gray-700 flex items-center">
                            Automated Data (CDOP) 
                            <span class="ml-2 text-xs font-medium text-blue-600">Hybrid Source</span>
                        </h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label for="cdopId" class="block text-sm font-medium text-gray-700">Simulated CDOP Project ID (Lookup)</label>
                                <input type="text" id="cdopId" name="cdopId" placeholder="e.g., 001-AFOLU-US" class="mt-1 block w-full input-automated p-2 border border-gray-300 rounded-md shadow-sm text-gray-800" value="001-AFOLU-US">
                            </div>
                            <div>
                                <label for="hostCountry" class="block text-sm font-medium text-gray-700">Host Country (Automated)</label>
                                <input type="text" id="hostCountry" name="hostCountry" class="mt-1 block w-full input-automated p-2 border border-gray-300 rounded-md shadow-sm text-gray-800" readonly>
                            </div>
                        </div>
                    </div>

                    <!-- Financial & Contract Input -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
                        <div>
                            <label for="projectName" class="block text-sm font-medium text-gray-700">Project Name</label>
                            <input type="text" id="projectName" name="projectName" required class="mt-1 block w-full input-manual p-2 border border-gray-300 rounded-md shadow-sm text-gray-800">
                        </div>
                        <div>
                            <label for="contractValue" class="block text-sm font-medium text-gray-700">Total Contract Value (USD)</label>
                            <input type="number" id="contractValue" name="contractValue" required class="mt-1 block w-full input-manual p-2 border border-gray-300 rounded-md shadow-sm text-gray-800" value="2000000">
                        </div>
                        <div>
                            <label for="offtakeTerm" class="block text-sm font-medium text-gray-700">Offtake Term (Years)</label>
                            <input type="number" id="offtakeTerm" name="offtakeTerm" required class="mt-1 block w-full input-manual p-2 border border-gray-300 rounded-md shadow-sm text-gray-800" value="5">
                        </div>
                        <div>
                            <label for="countryInformRisk" class="block text-sm font-medium text-gray-700">Country INFORM Risk (Automated)</label>
                            <input type="number" id="countryInformRisk" name="countryInformRisk" required step="0.1" class="mt-1 block w-full input-automated p-2 border border-gray-300 rounded-md shadow-sm text-gray-800" readonly>
                        </div>
                    </div>

                    <!-- Manual Score Input -->
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold mb-3 text-gray-700 flex items-center">
                            Manual CARVE Score Input (Tier III - Expert Judgment)
                            <span class="ml-2 text-xs font-medium text-red-600">Required</span>
                        </h3>
                        <label for="manualScores" class="block text-sm font-medium text-gray-700 mb-2">
                            Enter 7 scores (1-100) separated by commas only. **Order matters!**
                        </label>
                        <textarea id="manualScores" name="manualScores" rows="3" required class="mt-1 block w-full input-manual p-3 border border-gray-300 rounded-md shadow-sm text-gray-800" placeholder="e.g., 65, 80, 75, 95, 40, 70, 90 (7 scores total)">85, 90, 80, 75, 55, 60, 95</textarea>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex space-x-4">
                        <button type="button" id="loadSampleBtn" class="bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-150">
                            Load Sample Data (Biochar)
                        </button>
                        <button type="submit" id="runAnalysisBtn" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-150">
                            Run Single CARVE-Markov Analysis
                        </button>
                    </div>
                </form>
            </div>

            <!-- Results & Actions (Col 2) -->
            <div class="lg:col-span-1">
                <div class="card p-6 mb-8">
                    <h2 class="text-xl font-semibold mb-4 text-gray-800">Analysis Results</h2>

                    <div id="results-output">
                        <p class="text-gray-500 text-sm">Run analysis to see results...</p>
                    </div>

                    <button id="generateReportBtn" class="w-full mt-4 bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-4 rounded-lg shadow-lg transition duration-150" disabled>
                        Generate Full CARVE Report (PDF)
                    </button>
                </div>
                
                <!-- Bulk Analysis Section -->
                <div class="card p-6">
                    <h2 class="text-xl font-semibold mb-4 text-gray-800">Portfolio Triage</h2>
                    <p class="text-sm text-gray-600 mb-4">Run analysis on the 10 hard-coded test projects for instant portfolio triage.</p>
                    <button id="runBulkAnalysisBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-lg shadow-md transition duration-150">
                        Run Bulk Analysis (10 Test Projects)
                    </button>
                    <div id="bulk-results-output" class="mt-4"></div>
                </div>
            </div>
        </div>

        <!-- Report Output Section -->
        <div class="mt-8">
            <h2 class="text-2xl font-bold mb-4 text-gray-800">Final Report Preview</h2>
            <div id="report-output" class="card p-6 text-gray-700 min-h-[100px] bg-white border border-gray-200">
                A professional, narrative report will appear here after generation.
            </div>
        </div>
    </div>


    <script type="module">
       // --------------------------------------------------------------------------------
// IMPORTANT: SECURE API KEY SETUP (Must use a Cloudflare Worker)
// --------------------------------------------------------------------------------

// **Step 1: DEFINE THE VARIABLE HERE.** (This is the critical fix for the ReferenceError)
const WORKER_URL = "https://carve-gem-proxy.shawngagne.workers.dev/"; 
// Replace "https://carve-gem-proxy.shawngagne.workers.dev/" with your actual Cloudflare Worker URL!

// --- Final Security Check (Must check for the placeholder to prevent accidental sharing) ---
if (WORKER_URL.includes("YOUR_WORKER_URL_HERE")) {
    window.onload = () => { // We use onload to prevent crashing the initial script
        document.getElementById('report-output').innerHTML = `
            <div class="p-6 text-center text-red-700 bg-red-100 rounded-lg">
                <h3 class="text-xl font-bold">SECURITY ERROR: Worker URL Missing</h3>
                <p class="mt-2">Please replace the "YOUR_WORKER_URL_HERE" placeholder in the JavaScript code with your Cloudflare Worker URL.</p>
            </div>
        `;
    };
    // Throw error to stop the script from running Markov chain logic
    throw new Error("Worker URL placeholder detected. Script halted for security.");
}


// --------------------------------------------------------------------------------
// GLOBAL DATA AND SIMULATIONS
// --------------------------------------------------------------------------------
        const SIMULATED_CDOP_DATABASE = {
            '001-AFOLU-US': { projectName: 'AFOLU Project US', registryScore: 80, hostCountry: 'United States', countryInformRisk: 3.2, registry: 'VCS' },
            '002-ENGINEERED-CH': { projectName: 'Engineered Tech CH', registryScore: 95, hostCountry: 'Switzerland', countryInformRisk: 2.1, registry: 'Puro' },
            '003-AFOLU-CO': { projectName: 'AFOLU Project CO', registryScore: 75, hostCountry: 'Colombia', countryInformRisk: 5.3, registry: 'GS' },
            '004-AFOLU-SL': { projectName: 'AFOLU Project SL', registryScore: 80, hostCountry: 'Sierra Leone', countryInformRisk: 7.8, registry: 'VCS' },
            '005-BLUECARBON-ID': { projectName: 'Blue Carbon ID', registryScore: 85, hostCountry: 'Indonesia', countryInformRisk: 6.1, registry: 'VCS' },
        };

        // Hardcoded Test Projects (Used for Bulk Analysis)
        const TEST_PROJECTS = [
            // Note: Manual Scores are pre-calculated to allow for differences based on automated factors
            { id: '1', projectName: 'Indian Biochar Project', registry: 'Puro', hostCountry: 'India', offtakeTerm: 5, contractValue: 2000000, countryInformRisk: 5.6, manualScores: [65, 80, 75, 95, 40, 70, 90] },
            { id: 'VCS5212', projectName: 'BECCS', registry: 'VCS', hostCountry: 'Denmark', offtakeTerm: 5, contractValue: 17920128, countryInformRisk: 2.1, manualScores: [85, 90, 80, 75, 55, 60, 95] },
            { id: 'GS12234', projectName: 'Biochar', registry: 'GS', hostCountry: 'Colombia', offtakeTerm: 5, contractValue: 14850058, countryInformRisk: 5.3, manualScores: [70, 75, 70, 85, 45, 65, 85] },
            { id: 'VCS4001', projectName: 'Biochar', registry: 'VCS', hostCountry: 'Switzerland', offtakeTerm: 10, contractValue: 17092405, countryInformRisk: 2.1, manualScores: [90, 95, 85, 90, 70, 85, 95] },
            { id: 'VCS1378', projectName: 'Afforestation/Reforestation', registry: 'VCS', hostCountry: 'Colombia', offtakeTerm: 10, contractValue: 15181287, countryInformRisk: 5.3, manualScores: [50, 60, 50, 65, 30, 40, 60] },
            { id: 'VCS4255', projectName: 'Afforestation/Reforestation', registry: 'VCS', hostCountry: 'Sierra Leone', offtakeTerm: 7, contractValue: 17809379, countryInformRisk: 7.8, manualScores: [60, 65, 60, 70, 35, 45, 65] },
            { id: 'VCS5525', projectName: 'Direct Air Capture', registry: 'VCS', hostCountry: 'United States', offtakeTerm: 7, contractValue: 7927812, countryInformRisk: 3.2, manualScores: [88, 92, 85, 95, 75, 80, 95] },
            { id: 'CAR1009', projectName: 'Manure Methane Digester', registry: 'CAR', hostCountry: 'United States', offtakeTerm: 3, contractValue: 11653805, countryInformRisk: 3.2, manualScores: [90, 95, 90, 90, 80, 85, 95] },
            { id: 'ACR945', projectName: 'HFC Refrigerant Reclamation', registry: 'ACR', hostCountry: 'United States', offtakeTerm: 3, contractValue: 15840638, countryInformRisk: 3.2, manualScores: [92, 98, 92, 92, 85, 88, 98] },
            { id: 'GS11627', projectName: 'Carbon-Absorbing Concrete', registry: 'GS', hostCountry: 'Switzerland', offtakeTerm: 5, contractValue: 18061972, countryInformRisk: 2.1, manualScores: [90, 95, 90, 95, 80, 90, 95] },
        ];


        /**
         * Loads sample data (single project) into the form fields.
         */
        function loadSampleData(cdopId) {
            const defaultData = TEST_PROJECTS.find(p => p.id === '1') || TEST_PROJECTS[0]; // Use Indian Biochar as default

            // Load primary data
            document.getElementById('projectName').value = defaultData.projectName;
            document.getElementById('contractValue').value = defaultData.contractValue;
            document.getElementById('offtakeTerm').value = defaultData.offtakeTerm;

            // Load automated data based on CDOP ID
            const lookupId = cdopId || '001-AFOLU-US';
            const cdopData = SIMULATED_CDOP_DATABASE[lookupId] || {};

            // Update CDOP/Automated fields
            document.getElementById('cdopId').value = lookupId;
            document.getElementById('hostCountry').value = cdopData.hostCountry || defaultData.hostCountry;
            document.getElementById('countryInformRisk').value = cdopData.countryInformRisk || defaultData.countryInformRisk;

            // Load manual scores
            const manualScores = defaultData.manualScores;
            if (manualScores && manualScores.length === 7) {
                document.getElementById('manualScores').value = manualScores.join(', ');
            } else {
                document.getElementById('manualScores').value = '85, 90, 80, 75, 55, 60, 95'; // Failsafe default
            }
           
            // Clear previous results
            document.getElementById('results-output').innerHTML = '<p class="text-gray-500 text-sm">Run analysis to see results...</p>';
            document.getElementById('generateReportBtn').disabled = true;
            document.getElementById('report-output').innerHTML = 'A professional, narrative report will appear here after generation.';
            document.getElementById('error-message').classList.add('hidden');
        }


        /**
         * Validates the form data and returns a structured object or null if validation fails.
         */
        function getFormData(isBulk = false) {
            // Logic is robust, unchanged from previous versions (omitted for brevity)
            const form = document.getElementById('carveForm');
            const data = {};
            const errors = [];

            // Helper for validation
            const getValue = (id, type = 'string') => {
                const element = document.getElementById(id);
                if (isBulk && !element) return null; // Skip if element not found during bulk
                const value = element.value.trim();

                if (!value && element.required) {
                    errors.push(`${element.labels[0].textContent || id} is required.`);
                }
                
                if (type === 'number') {
                    const num = parseFloat(value);
                    if (isNaN(num) || num <= 0) {
                        errors.push(`${element.labels[0].textContent || id} must be a positive number.`);
                        return 0;
                    }
                    return num;
                }
                return value;
            };

            // 1. Core Financial/Contract Data (Manual)
            data.projectName = getValue('projectName');
            data.offtakeTerm = getValue('offtakeTerm', 'number');
            data.contractValue = getValue('contractValue', 'number');

            // 2. Automated/CDOP Data (Simulated)
            data.cdopId = getValue('cdopId');
            data.hostCountry = getValue('hostCountry');
            data.countryInformRisk = getValue('countryInformRisk', 'number');

            // Find registry for manual score calculation (default to first letter of CDOP ID)
            const cdopLookup = SIMULATED_CDOP_DATABASE[data.cdopId];
            data.registry = cdopLookup ? cdopLookup.registry : 'VCS';
            data.registryScore = cdopLookup ? cdopLookup.registryScore : 80;


            // 3. Manual CARVE Scores (Tier III)
            const scoreString = getValue('manualScores');
            const manualScores = scoreString.split(',').map(s => parseFloat(s.trim()));
            data.manualScores = manualScores;

            if (manualScores.length !== 7 || manualScores.some(isNaN) || manualScores.some(s => s < 1 || s > 100)) {
                errors.push("Manual CARVE Scores must be 7 numbers (1-100), separated by commas.");
            }

            if (errors.length > 0) {
                if (!isBulk) {
                    const errorBox = document.getElementById('error-message');
                    errorBox.innerHTML = `<strong>Validation Errors:</strong><ul>${errors.map(e => `<li>- ${e}</li>`).join('')}</ul>`;
                    errorBox.classList.remove('hidden');
                }
                return null;
            }

            document.getElementById('error-message').classList.add('hidden');
            return data;
        }

        /**
         * The core CARVE engine logic. Calculates scores and Markov probabilities.
         */
        function calculateCarveScore(data) {
            // Logic is robust, unchanged from previous versions (omitted for brevity)
            // Unpack Manual Scores (Tier III - Expert Judgment)
            const [
                scoreFinViab, scoreFinViabPrePay, scoreCommRisk, scoreMethodology, 
                scoreOnTimeIssuance, scoreCommRiskPol, scoreCommRiskSoc
            ] = data.manualScores;
            
            // --- 1. Weighting the Scores ---

            // A. Tier III: Execution & Financial (70% Weight)
            const T3_WEIGHTS = { 
                finViab: 0.10, finViabPrePay: 0.15, onTimeIssuance: 0.15, methodology: 0.10, commRiskTotal: 0.20,
            };

            const t3Score = (
                scoreFinViab * T3_WEIGHTS.finViab +
                scoreFinViabPrePay * T3_WEIGHTS.finViabPrePay +
                scoreOnTimeIssuance * T3_WEIGHTS.onTimeIssuance +
                scoreMethodology * T3_WEIGHTS.methodology +
                (scoreCommRisk + scoreCommRiskPol + scoreCommRiskSoc) / 3 * T3_WEIGHTS.commRiskTotal
            );

            // B. Tier II: Registry Risk (15% Weight)
            const T2_WEIGHT = 0.15;
            const t2Score = data.registryScore * T2_WEIGHT; 

            // C. Tier I: External Risk (15% Weight)
            const T1_WEIGHT = 0.15;
            const externalRiskScore = 100 - (data.countryInformRisk / 10) * 100;
            const t1Score = externalRiskScore * T1_WEIGHT;

            const finalCarveScore = (t1Score + t2Score + t3Score).toFixed(1);

            // --- 2. Markov Chain Transition Matrix ---
            const risk_factor = 100 - parseFloat(finalCarveScore);
            const term = data.offtakeTerm;

            const p_to_u_base = 0.05 + (risk_factor / 100) * 0.10;
            const u_to_d_base = 0.05 + (risk_factor / 100) * 0.15;

            const P_to_U = p_to_u_base;
            const P_to_D = 0.005;
            const P_to_P = 1 - P_to_U - P_to_D;

            const U_to_D = u_to_d_base;
            const U_to_P = 0.02;
            const U_to_U = 1 - U_to_D - U_to_P;

            const D_to_D = 1;

            const T = [
                [P_to_P, P_to_U, P_to_D],
                [U_to_P, U_to_U, U_to_D],
                [0, 0, D_to_D]
            ];

            // --- 3. Run Markov Simulation for Term ---
            let Pn = [1, 0, 0];
            for (let t = 0; t < term; t++) {
                let P_next = [0, 0, 0];
                for (let i = 0; i < 3; i++) {
                    for (let j = 0; j < 3; j++) {
                        P_next[j] += Pn[i] * T[i][j];
                    }
                }
                Pn = P_next;
            }

            const p_collapse = Pn[2];
            const p_underdelivering = Pn[1];
            const p_performing = Pn[0];
            const p_offtake_underperformance = p_underdelivering + p_collapse;

            // --- 4. Final Financial Metrics ---
            const contractValue = data.contractValue;
            const valueAtRisk = contractValue * p_collapse;

            // --- 5. Generate Audit Log (Task 5.1) ---
            const auditLog = {
                'Project Name': { value: data.projectName, source: 'Analyst Input' },
                'Offtake Term': { value: `${data.offtakeTerm} Years`, source: 'Analyst Input' },
                'Total Contract Value': { value: `$${data.contractValue.toLocaleString()}`, source: 'Analyst Input' },
                'Registry Governance': { value: `${data.registry} (${data.registryScore})`, source: 'CDOP Simulation' },
                'Host Country Risk (INFORM)': { value: data.countryInformRisk, source: 'CDOP/INFORM Data' },
                'Financial Viability': { value: `${scoreFinViab}`, source: 'Expert Analyst Input' },
                'Pre-Payment Status Score': { value: `${scoreFinViabPrePay}`, source: 'Expert Analyst Input' },
                'On-Time Issuance History': { value: `${scoreOnTimeIssuance}`, source: 'Expert Analyst Input' },
                'Methodology Robustness': { value: `${scoreMethodology}`, source: 'Expert Analyst Input' },
                'Community/Social/Political Risk': { value: `${scoreCommRisk}, ${scoreCommRiskPol}, ${scoreCommRiskSoc}`, source: 'Expert Analyst Input' },
            };


            return {
                finalCarveScore, p_collapse: (p_collapse * 100).toFixed(2), p_underdelivering: (p_underdelivering * 100).toFixed(2),
                p_performing: (p_performing * 100).toFixed(2), p_offtake_underperformance: (p_offtake_underperformance * 100).toFixed(2),
                valueAtRisk: valueAtRisk.toFixed(0), auditLog: auditLog, data: data
            };
        }

        /**
         * Main function to run single analysis when form is submitted.
         */
        function runAnalysis() {
            const data = getFormData();
            if (!data) return;

            const results = calculateCarveScore(data);
            window.lastAnalysisData = data;
            window.lastAnalysisResults = results;

            // Display results
            document.getElementById('results-output').innerHTML = `
                <div class="space-y-4">
                    <div class="score-box p-3 rounded-lg flex justify-between items-center font-bold text-lg">
                        <span>CARVE Risk Score:</span>
                        <span>${results.finalCarveScore} / 100</span>
                    </div>
                    <div class="flex justify-between text-gray-700">
                        <span class="font-medium">P(Total Collapse):</span>
                        <span class="font-semibold text-red-600">${results.p_collapse}%</span>
                    </div>
                    <div class="flex justify-between text-gray-700">
                        <span class="font-medium">Cumulative VaR:</span>
                        <span class="font-semibold text-red-600">$${parseInt(results.valueAtRisk).toLocaleString()}</span>
                    </div>
                </div>
            `;
            document.getElementById('generateReportBtn').disabled = false;
        }

        /**
         * Runs the bulk analysis on the 10 test projects.
         */
        function runBulkAnalysis() {
            // Logic is robust, unchanged from previous versions (omitted for brevity)
            const bulkResults = [];
            
            TEST_PROJECTS.forEach(project => {
                const data = { ...project, manualScores: project.manualScores };
                data.registryScore = (data.registry === 'Puro' || data.registry === 'GS') ? 90 : 80;
                
                const results = calculateCarveScore(data);
                
                bulkResults.push({
                    id: project.id, name: project.projectName, location: project.hostCountry, term: project.offtakeTerm,
                    carveScore: results.finalCarveScore, pCollapse: results.p_collapse,
                    vaR: parseInt(results.valueAtRisk).toLocaleString()
                });
            });

            // Display bulk results
            document.getElementById('bulk-results-output').innerHTML = `
                <h3 class="text-lg font-semibold mb-2 text-gray-700">Portfolio Summary</h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full text-xs text-left text-gray-500">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                            <tr>
                                <th scope="col" class="px-3 py-2">ID / Project</th>
                                <th scope="col" class="px-3 py-2">Score</th>
                                <th scope="col" class="px-3 py-2">P(Collapse)</th>
                                <th scope="col" class="px-3 py-2">VaR</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${bulkResults.map(r => `
                                <tr class="bg-white border-b hover:bg-gray-50">
                                    <td class="px-3 py-2 font-medium text-gray-900">${r.id} / ${r.location}</td>
                                    <td class="px-3 py-2">${r.carveScore}</td>
                                    <td class="px-3 py-2 text-red-600">${r.pCollapse}%</td>
                                    <td class="px-3 py-2 text-red-600">$${r.vaR}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        /**
         * Formats the audit log into a clean Markdown string for the LLM prompt.
         */
        function formatAuditLog(auditLog) {
            let markdown = "";
            for (const [key, item] of Object.entries(auditLog)) {
                markdown += `* **${key}:** ${item.value} (Source: ${item.source})\n`;
            }
            return markdown;
        }

        /**
         * Calls the secure Cloudflare Worker to generate the final report.
         */
        async function generateFinalReport(btn) {
            if (!window.lastAnalysisResults || !window.lastAnalysisData) {
                document.getElementById('report-output').innerHTML = `<p class="text-red-500">Error: Please run the analysis first.</p>`;
                return;
            }

            if (WORKER_URL === "carve-gem-proxy.shawngagne.workers.dev") {
                document.getElementById('report-output').innerHTML = `<p class="text-red-500 font-bold">SECURITY ERROR: Please replace "YOUR_WORKER_URL_HERE" in the code with your Cloudflare Worker URL.</p>`;
                return;
            }

            const results = window.lastAnalysisResults;
            const data = window.lastAnalysisData;
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = 'Generating Report...';
            document.getElementById('report-output').innerHTML = '<p class="text-blue-600 animate-pulse">Running Gemini analysis and compiling report...</p>';

            const auditMarkdown = formatAuditLog(results.auditLog);

            // System Instruction (Persona & Structure) - Omitted for brevity
            const systemPrompt = `
                Act as a Chief Climate Scientist and Senior Financial Risk Analyst. Your goal is to provide a formal, professional, and actionable risk assessment.
                The report MUST be delivered in clear, clean Markdown format.

                The report MUST follow this structure precisely:
                1. Executive Summary: (Provide the Bottom Line Up Front: CARVE Score, P(Collapse), and VaR.)
                2. Methodology & Findings: (Explain the Hybrid Scoring Model, the Markov Chain, and the Transition Risk.)
                3. Actionable Contractual Mitigation: (Translate the risk into 3 mandatory contractual defense mechanisms, referencing the VaR and P(Collapse) figures.)
                4. Terms and Conditions: (Insert the full, verbatim terms and conditions provided in the prompt.)
                5. Annex: Data Sourcing and Audit Trail: (Insert the full audit log provided in the prompt in a Markdown list format.)

                Maintain a formal, authoritative, and non-dramatic tone.
            `;

            // User Query (Input Data) - Omitted for brevity
            const userQuery = `
                Generate a financial risk assessment report for the following VCM project based on the CARVE-Markov Engine results.

                --- PROJECT DATA ---
                Project Name: ${data.projectName}
                Host Country: ${data.hostCountry}
                Offtake Term: ${data.offtakeTerm} years
                Total Contract Value: $${data.contractValue.toLocaleString()}
                
                --- MARKOV RESULTS ---
                CARVE Score (0-100): ${results.finalCarveScore}
                Probability of Total Collapse (P(D)): ${results.p_collapse}%
                Cumulative Value at Risk (VaR): $${parseInt(results.valueAtRisk).toLocaleString()}
                Probability of Offtake Underperformance (P(U+D)): ${results.p_offtake_underperformance}%
                
                --- MANDATORY TERMS AND CONDITIONS ---
                This report is for informational purposes only. The analysis relies on proprietary, simulated data and expert judgment, and it is not a guarantee of future performance, nor should it be used as the sole basis for investment or contractual decisions. Climate Risk Analysis (CRA) and its analysts are not registered financial advisors. By using this analysis, the client agrees to hold CRA harmless from any financial loss or contractual dispute resulting from the use or misinterpretation of this data. The client acknowledges that the CARVE Score is a relative, predictive metric and not a rating from a credit agency.
                
                --- AUDIT LOG ---
                ${auditMarkdown}
            `;


            const payload = { contents: [{ parts: [{ text: userQuery }] }], systemInstruction: { parts: [{ text: systemPrompt }] } };

            try {
                // **SECURITY FIX IS HERE:** Fetching the Worker URL, not the Google API
                const response = await fetch(WORKER_URL, { 
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text || "Error: Could not generate report content.";

                document.getElementById('report-output').innerHTML = text.replace(/```markdown|```/g, ''); // Clean up the markdown block
                
            } catch (error) {
                console.error("API Call failed:", error);
                document.getElementById('report-output').innerHTML = `<p class="text-red-500 font-bold">Report Generation Failed. Check Console for Error.</p><p class="text-sm text-gray-600 mt-2">Potential issues: Worker URL is incorrect, or the Cloudflare Worker is not deployed/authorized.</p>`;
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        // Helper function for modal
        function toggleModal(id, show) {
            document.getElementById(id).style.display = show ? 'flex' : 'none';
        }


        // --------------------------------------------------------------------------------
        // INITIALIZATION AND EVENT LISTENERS (The Fix for ReferenceError)
        // --------------------------------------------------------------------------------

        function initialSetup() {
            loadSampleData('001-AFOLU-US'); // Load default data on startup
            runBulkAnalysis(); // Run bulk analysis on load to show portfolio context
        }

        window.onload = initialSetup;

        // **The Fix:** Attach functions to buttons using IDs, not inline `onclick`
        document.getElementById('openModalBtn').addEventListener('click', () => toggleModal('helpModal', true));
        document.getElementById('closeModalBtn').addEventListener('click', () => toggleModal('helpModal', false));
        document.getElementById('loadSampleBtn').addEventListener('click', () => loadSampleData('001-AFOLU-US'));
        document.getElementById('runBulkAnalysisBtn').addEventListener('click', runBulkAnalysis);

        document.getElementById('carveForm').addEventListener('submit', function(e) {
            e.preventDefault();
            runAnalysis();
        });

        document.getElementById('generateReportBtn').addEventListener('click', function(e) {
            generateFinalReport(this);
        });
        
        // Auto-update CDOP data when the ID input changes
        document.getElementById('cdopId').addEventListener('input', (e) => {
            const id = e.target.value.trim();
            const cdopData = SIMULATED_CDOP_DATABASE[id];

            if (cdopData) {
                document.getElementById('hostCountry').value = cdopData.hostCountry;
                document.getElementById('countryInformRisk').value = cdopData.countryInformRisk;
            } else {
                document.getElementById('hostCountry').value = 'N/A';
                document.getElementById('countryInformRisk').value = '';
            }
        });


    </script>
</body>
</html>
